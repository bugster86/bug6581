- debug: msg="Sto aggiornando l'istanza {{ item }}"

- name: "Controllo se l'istanza {{ item }} Ã¨ una mysql 5.5"
  shell: "grep version= {{ item }}/install/mysql/bin/mysql_config | grep "5.5.30" "
  failed_when: false
  changed_when: false
  check_mode: false
  register: versione_corretta

- stat: path="{{ item }}/bin/mariadb_config"
  register: mariadb

- block:
  - name: "Copio il file server_audit.so in {{ item }}/install/mysql/lib/plugin/"
    copy:
     owner: root
     group: root
     mode: 0644
     src: files/server_audit.so
     dest: "{{ item }}/install/mysql/lib/plugin/"

  - include: include/conf_mysql.yml

  # Adesso posso caricare direttamente a runtime il plugin
  - name: carico il plugin a runtime per l'istanza mysql
    shell: mysql -e "INSTALL PLUGIN server_audit SONAME 'server_audit.so';"

  - name: recupero il riferimento per eventuali altri istanze mysql
    shell: ls -1 /usr/bin/mysql[0-9][0-9]
    # qui facciamo l'ipotesi forte che le istanza mysql siano sempre del tipo mysql01 mysql02 mysql03 mysql04 ,....
    failed_when: false
    changed_when: false
    check_mode: false
    register: altri_mysql

  - shell: "{{ item }} -e "INSTALL PLUGIN server_audit SONAME 'server_audit.so';""
    with_items:
    - "{{ altri_mysql.stdout_lines }}"

  when:
  - versione_corretta.rc == 0
  - mariadb.stat.exists == false
